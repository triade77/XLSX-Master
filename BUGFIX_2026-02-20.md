# 버그 수정 리포트: Excel 복구 오류 (drawing1.xml 제거 문제)
> 날짜: 2026-02-20
> 상태: ✅ 해결 완료 (테스트 12/12 통과, Excel 정상 오픈 확인)

---

## 증상

생성된 `.xlsx` 파일을 Excel로 열면:
1. "파일을 복구했습니다" 다이얼로그 표시
2. 차트가 표시되지 않음
3. 복구 로그에 다음 내용 기록:

```xml
<removedPart>
  제거된 요소: /xl/drawings/drawing1.xml 요소 (도형 그리기)
</removedPart>
```

---

## 원인 분석

### 진단 방법
`OpenXmlValidator`를 사용한 스키마 검증 테스트(`ValidationTests.cs`)를 추가하여 정확한 오류 위치 확인:

```
[Schema] The element has invalid child element
'http://schemas.openxmlformats.org/drawingml/2006/chart:strLit'.
List of possible elements expected:
  <c:strRef>, <c:v>.
(Part: /xl/charts/chart1.xml)
```

### 근본 원인

`ChartXmlGenerator.BuildSeriesText()`에서 계열 이름을 `<c:strLit>`(StringLiteral)로 생성하고 있었음.

**OOXML 스키마 규칙** — `CT_SerTx` (`<c:tx>`, 계열 텍스트) 의 유효한 자식 요소:
| 요소 | 용도 | 허용 여부 |
|------|------|-----------|
| `<c:strRef>` | 셀 참조 (e.g. `Sheet1!$A$1`) | ✅ |
| `<c:v>` | 리터럴 문자열 값 | ✅ |
| `<c:strLit>` | 문자열 리터럴 배열 | ❌ **(다른 컨텍스트 전용)** |

> **헷갈리는 점**: `<c:strLit>`는 카테고리 축 데이터(`CT_AxDataSource`) 컨텍스트에서는 허용됨.
> 하지만 계열 이름(`CT_SerTx`) 컨텍스트에서는 금지.

Excel은 `chart1.xml` 스키마 위반을 감지하고, 해당 차트를 참조하는 `drawing1.xml` 전체를 제거하는 복구 처리를 수행함.

---

## 수정 내용

### 1. `src/XLSX-Master/Charts/ChartXmlGenerator.cs` — 핵심 수정

```csharp
// ❌ 수정 전 — c:strLit 은 c:tx 에서 스키마 위반
private static SeriesText BuildSeriesText(string name)
{
    return new SeriesText(
        new StringLiteral(
            new PointCount { Val = 1u },
            new StringPoint(new NumericValue(name)) { Index = 0u }
        )
    );
}

// ✅ 수정 후 — c:v (NumericValue) 사용
private static SeriesText BuildSeriesText(string name)
{
    // CT_SerTx 는 c:v 만 허용 (NumericValue 클래스가 c:v 에 매핑됨)
    return new SeriesText(new NumericValue(name));
}
```

생성되는 XML 비교:
```xml
<!-- 수정 전 (스키마 위반) -->
<c:tx>
  <c:strLit>
    <c:ptCount val="1"/>
    <c:pt idx="0"><c:v>매출액(억)</c:v></c:pt>
  </c:strLit>
</c:tx>

<!-- 수정 후 (올바름) -->
<c:tx>
  <c:v>매출액(억)</c:v>
</c:tx>
```

### 2. `src/XLSX-Master/Core/XlsxChartInjector.cs` — 추가 개선

| 항목 | 변경 전 | 변경 후 | 이유 |
|------|---------|---------|------|
| `AddDrawingElementToSheet` | XDocument 파싱 후 재직렬화 | 문자열 직접 삽입 | XDocument 라운드트립 시 미세한 XML 변형 가능성 제거 |
| `EnsureContentType` | XDocument 파싱 후 재직렬화 | 문자열 직접 삽입 | 동일 |
| `drawing1.xml`의 `xmlns:c` | `<xdr:wsDr>` 루트에 선언 | `<c:chart>` 인라인 선언 | 실제 Excel 생성 방식과 일치 |

### 3. `tests/XLSX-Master.Tests/ValidationTests.cs` — 신규 추가

```csharp
[TestMethod]
public void GeneratedXlsx_PassesOpenXmlValidation()
{
    // 파일 생성 후 OpenXmlValidator로 스키마 검증
    var validator = new OpenXmlValidator();
    var errors = validator.Validate(doc).ToList();
    // 오류가 있으면 상세 메시지와 함께 실패
    Assert.AreEqual(0, errors.Count, ...);
}
```

---

## 결과

```
통과!  - 실패: 0, 통과: 12, 건너뜀: 0, 전체: 12
```

| 테스트 | 수 |
|--------|---|
| EmuCalculatorTests | 8 |
| IntegrationTests | 3 |
| ValidationTests | 1 |

---

## 교훈

### ⚡ OpenXmlValidator를 먼저 쓸 것

Excel 복구 로그만으로는 원인 파악이 어렵다.
`OpenXmlValidator.Validate(doc)`를 통합 테스트에 포함시키면 스키마 오류를 즉시 정확하게 잡을 수 있다.

### ⚠️ Open XML SDK의 타입 이름을 믿지 말 것

`NumericValue`라는 이름이지만 실제로는 `c:v` 요소로 매핑되어 **문자열에도 사용**된다.
`StringLiteral`(`c:strLit`)은 이름과 달리 계열 텍스트 컨텍스트에서는 사용 불가.
→ 항상 OOXML 스키마(`CT_SerTx`, `CT_AxDataSource` 등)를 확인할 것.
